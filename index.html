<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live RFID Tracking Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        #map { height: 75vh; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .tab-btn { transition: background-color 0.2s, color 0.2s; }
        .tab-btn.active { background-color: #4f46e5; color: white; }
        .tab-btn:not(.active) { background-color: #e0e7ff; color: #4338ca; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .highlight { animation: fadein 0.7s ease-out; }
        @keyframes fadein { from { background-color: #c7d2fe; } to { background-color: transparent; } }
    </style>
</head>
<body class="p-4 md:p-6">
    <div class="max-w-7xl mx-auto">
        <div class="text-center mb-4 text-sm font-bold text-gray-500">
            Powered by CONRAD ROBOTICS
        </div>

        <header class="bg-white text-slate-800 p-6 rounded-xl shadow-lg mb-6">
            <h1 class="text-3xl font-bold text-indigo-700">Live RFID Tracking Dashboard</h1>
            <p class="mt-1 text-slate-500">
                Listening for data from your ESP32 device.
            </p>
            <div id="status" class="mt-4 text-sm font-medium p-2 rounded-lg inline-block bg-yellow-400 text-yellow-800">
                STATUS: Connecting to MQTT Broker...
            </div>
        </header>

        <div class="mb-6 flex space-x-2 p-1 bg-indigo-100 rounded-lg">
            <button class="tab-btn flex-1 py-2 px-4 rounded-md font-semibold active" onclick="showTab('log')">Live Log</button>
            <button class="tab-btn flex-1 py-2 px-4 rounded-md font-semibold" onclick="showTab('map')">Map View</button>
            <button class="tab-btn flex-1 py-2 px-4 rounded-md font-semibold" onclick="showTab('settings')">Device Settings & Registration</button>
        </div>

        <main>
            <div id="log" class="tab-content active bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Real-time Scan Data Log</h2>
                <div class="max-h-[70vh] overflow-y-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="sticky top-0 bg-gray-50 z-10">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Timestamp</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Identifier</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Location</th>
                            </tr>
                        </thead>
                        <tbody id="log-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>

            <div id="map" class="tab-content"></div>

            <div id="settings" class="tab-content">
                <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">ESP32 Device Status</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div><span class="font-bold text-gray-600">IP Address:</span> <span id="status-ip" class="font-mono text-indigo-700">Waiting...</span></div>
                        <div><span class="font-bold text-gray-600">Connected Wi-Fi:</span> <span id="status-ssid" class="font-mono text-indigo-700">Waiting...</span></div>
                        <div><span class="font-bold text-gray-600">SD Card Usage:</span> <span id="status-sd" class="font-mono text-indigo-700">Waiting...</span></div>
                        <div><span class="font-bold text-gray-600">Device Uptime:</span> <span id="status-uptime" class="font-mono text-indigo-700">Waiting...</span></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">Device Management</h2>
                        <div class="space-y-4">
                            <a id="download-log-btn" href="#" target="_blank" class="block w-full text-center bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md opacity-50 cursor-not-allowed">Download Full Log (.csv)</a>
                            <button id="clear-log-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg shadow-md">Clear All SD Card Logs</button>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">Register RFID Tag</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="reg-uid" class="block text-sm font-medium text-gray-700">Last Scanned UID</label>
                                <input type="text" id="reg-uid" class="mt-1 block w-full px-3 py-2 bg-gray-100 border rounded-md" readonly>
                            </div>
                            <div>
                                <label for="reg-name" class="block text-sm font-medium text-gray-700">Assign Name</label>
                                <input type="text" id="reg-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="e.g., Main Gate Key">
                            </div>
                            <button id="register-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Register Name</button>
                        </div>
                    </div>
                    
                    <div class="md:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                         <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">Configure ESP32 Wi-Fi</h2>
                        <p class="text-sm text-amber-700 bg-amber-100 p-3 rounded-md mb-4">
                            <strong>Warning:</strong> Submitting will save credentials to the SD card and reboot the device.
                        </p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                            <div class="md:col-span-1">
                                <label for="wifi-ssid" class="block text-sm font-medium text-gray-700">Wi-Fi Network (SSID)</label>
                                <input type="text" id="wifi-ssid" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                            </div>
                            <div class="md:col-span-1">
                                <label for="wifi-pass" class="block text-sm font-medium text-gray-700">Password</label>
                                <input type="password" id="wifi-pass" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                            </div>
                            <button id="wifi-update-btn" class="md:col-span-1 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Update & Reboot</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- Global State ---
        let esp32_ip = null;
        let registered_names = {};
        let map;
        let lastMarker;

        // --- MQTT Configuration ---
        const MQTT_BROKER_HOST = "broker.hivemq.com";
        const MQTT_BROKER_PORT = 8884; // Port for WSS (WebSocket Secure)
        const MQTT_DATA_TOPIC = "esp32/rfid/data";
        const MQTT_STATUS_TOPIC = "esp32/rfid/status";
        const MQTT_COMMAND_TOPIC = "esp32/rfid/command";
        const MQTT_CLIENT_ID = "WebAppClient_" + Math.random().toString(16).substr(2, 8);

        // --- MQTT Client Setup ---
        const client = new Paho.Client(MQTT_BROKER_HOST, MQTT_BROKER_PORT, MQTT_CLIENT_ID);
        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;
        client.connect({ onSuccess: onConnect, onFailure: onFailure, useSSL: true }); // <-- `onFailure` is now defined below

        // ======================= FIX 1: ADDED MISSING `onFailure` FUNCTION =======================
        function onFailure(responseObject) {
            console.error("MQTT Connection Failed:", responseObject.errorMessage);
            updateStatus(`Connection Failed: ${responseObject.errorMessage}`, "bg-red-100 text-red-800");
        }

        function onConnect() {
            updateStatus("Connected & Listening for Device", "bg-green-100 text-green-800");
            client.subscribe(MQTT_DATA_TOPIC);
            client.subscribe(MQTT_STATUS_TOPIC);
        }
        
        // --- Message Handlers ---
        function onMessageArrived(message) {
            const topic = message.destinationName;
            const payload = message.payloadString;
            try {
                const data = JSON.parse(payload);
                if (topic === MQTT_DATA_TOPIC) {
                    handleDataMessage(data);
                } else if (topic === MQTT_STATUS_TOPIC) {
                    handleStatusMessage(data);
                }
            } catch (e) { console.error("Error processing message:", e); }
        }

        function handleDataMessage(data) {
            document.getElementById('reg-uid').value = data.identifier;
            const displayName = registered_names[data.identifier] 
                ? `${registered_names[data.identifier]} (${data.identifier})` 
                : data.identifier;
            
            insertDataRow(data.timestamp, displayName, data.latitude, data.longitude, data.identifier);
            updateMap(displayName, data.latitude, data.longitude);
        }

        function handleStatusMessage(data) {
            console.log("Status update:", data);
            esp32_ip = data.ip;
            document.getElementById('status-ip').textContent = data.ip || 'N/A';
            document.getElementById('status-ssid').textContent = data.ssid || 'N/A';
            document.getElementById('status-uptime').textContent = data.uptime_ms ? `${(data.uptime_ms / 1000 / 60).toFixed(2)} mins` : 'N/A';
            
            if(data.sd_total_gb) {
                 document.getElementById('status-sd').textContent = `${data.sd_used_gb.toFixed(3)} / ${data.sd_total_gb.toFixed(2)} GB`;
            } else {
                 document.getElementById('status-sd').textContent = data.sd_status || 'N/A';
            }

            if (esp32_ip && esp32_ip !== "0.0.0.0") {
                const downloadBtn = document.getElementById('download-log-btn');
                downloadBtn.href = `http://${esp32_ip}/downloadlog`;
                downloadBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            if (data.registered_names) {
                registered_names = data.registered_names;
            }
        }
        
        // --- UI & Event Listeners ---
        document.getElementById('wifi-update-btn').addEventListener('click', () => {
            const ssid = document.getElementById('wifi-ssid').value;
            const password = document.getElementById('wifi-pass').value;
            if (!ssid) { alert('SSID cannot be empty.'); return; }
            if (confirm(`Send new Wi-Fi credentials to ESP32?\n\nSSID: ${ssid}\n\nThe device will reboot.`)) {
                sendCommand({ action: "update_wifi", ssid: ssid, password: password });
            }
        });

        document.getElementById('register-btn').addEventListener('click', () => {
            const uid = document.getElementById('reg-uid').value;
            const name = document.getElementById('reg-name').value;
            if (uid && name) {
                sendCommand({ action: "register_card", uid: uid, name: name });
                alert(`Registration command sent for "${name}"`);
                document.getElementById('reg-name').value = '';
            } else {
                alert('Please ensure a UID is present and a name is entered.');
            }
        });

        document.getElementById('clear-log-btn').addEventListener('click', () => {
            if (confirm('DANGER! This will permanently delete the entire datalog.csv file from the ESP32 SD card. Are you absolutely sure?')) {
                sendCommand({ action: "clear_log" });
                alert('Command to clear log has been sent.');
            }
        });

        function sendCommand(payload) {
            const message = new Paho.Message(JSON.stringify(payload));
            message.destinationName = MQTT_COMMAND_TOPIC;
            client.send(message);
        }

        // --- Helper Functions ---
        function insertDataRow(timestamp, displayName, lat, lon, rawIdentifier) {
            const newRow = document.getElementById('log-table-body').insertRow(0);
            newRow.className = "highlight";
            newRow.insertCell().textContent = timestamp;

            const nameCell = newRow.insertCell();
            nameCell.textContent = displayName;
            
            // If the name is a registered name, make the raw ID smaller
            if (displayName !== rawIdentifier) {
                 nameCell.innerHTML = `${registered_names[rawIdentifier]} <span class="text-xs text-gray-400">(${rawIdentifier})</span>`;
            }

            const cellLoc = newRow.insertCell();
            if (lat !== "0.0" && lon !== "0.0") {
                // ======================= FIX 2: CORRECTED GOOGLE MAPS LINK =======================
                cellLoc.innerHTML = `<a href="https://www.google.com/maps?q=${lat},${lon}" target="_blank" class="text-blue-600 hover:underline">View Map</a>`;
            } else {
                cellLoc.textContent = "N/A";
            }
        }
        
        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                updateStatus("Connection Lost. Reconnecting...", "bg-red-100 text-red-800");
            }
        }
        
        function updateStatus(message, bgColor) {
            const statusEl = document.getElementById("status");
            statusEl.textContent = `STATUS: ${message}`;
            statusEl.className = `mt-4 text-sm font-medium p-2 rounded-lg inline-block ${bgColor}`;
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`button[onclick="showTab('${tabName}')"]`).classList.add('active');
            // Invalidate map size when tab is shown to prevent gray tiles
            if (tabName === 'map' && map) {
                setTimeout(() => map.invalidateSize(), 10);
            }
        }

        // ======================= FIX 2 (CONT.): MAP INITIALIZATION & UPDATE LOGIC =======================
        function initializeMap() {
            map = L.map('map').setView([9.0765, 7.3986], 6); // Default view (e.g., Nigeria)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
        }

        function updateMap(displayName, lat, lon) {
            if (lat === "0.0" || lon === "0.0" || !map) return;
            
            const latNum = parseFloat(lat);
            const lonNum = parseFloat(lon);

            if (lastMarker) {
                map.removeLayer(lastMarker);
            }

            lastMarker = L.marker([latNum, lonNum]).addTo(map)
                .bindPopup(`<b>Last Scan:</b><br>${displayName}`)
                .openPopup();
            
            map.setView([latNum, lonNum], 15);
        }

        document.addEventListener('DOMContentLoaded', () => {
            showTab('log');
            initializeMap();
        });
    </script>
</body>
</html>
